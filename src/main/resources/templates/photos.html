<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>–í—Å–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</title>
    <link th:href="@{/css/root.css}" rel="stylesheet">
    <link th:href="@{/css/header.css}" rel="stylesheet">
    <link th:href="@{/css/footer.css}" rel="stylesheet">
    <link th:href="@{/css/photos.css}" rel="stylesheet">


</head>
<body>

<header th:insert="~{fragment :: header}"></header>

<div style="margin-top: 50px;">



<div class="fixed-top fixed-filter">
    <h2 style="color: var(--red)">–§–∏–ª—å—Ç—Ä</h2>
    <div>
        <button class="filter-btn active" data-folder="all"><p>–í—Å–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</p></button>
        <button class="filter-btn" data-folder="–ù–æ–≤—ã–µ —Ñ–æ—Ç–æ"><p>–ù–æ–≤—ã–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</p></button>
        <button class="filter-btn" data-folder="–°—Ç–∞—Ä—ã–µ —Ñ–æ—Ç–æ"><p>–°—Ç–∞—Ä—ã–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</p></button>
    </div>
</div>

<div class="content">
    <h1 style="padding-bottom: 30px;">–§–æ—Ç–æ–≥–∞–ª–µ—Ä–µ—è</h1>
    <div class="gallery" id="gallery">
        <div style="width:100%; text-align:center; padding:40px; color:#666;">
            –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π...
        </div>
    </div>

</div>

<div class="fixed-top fixed-back">
    <a href="javascript:void(0)" class="back-btn" onclick="goBack()">
        <h3>–ù–∞–∑–∞–¥</h3>
    </a>
</div>


<div class="modal" id="modal">
    <span class="modal-close" id="modal-close">√ó</span>
    <div class="modal-nav modal-prev" id="modal-prev" style="user-select: none;">ü°Ñ</div>
    <div class="modal-nav modal-next" id="modal-next" style="user-select: none;">ü°Ü</div>
    <img id="modal-image" src="" alt="">
</div>

</div>


<footer th:insert="~{fragment :: footer}"></footer>


<script>
    function goBack() {
        if (window.history.length > 1) {
            window.history.back();
        } else {
            window.location.href = '/';
        }
    }
</script>

<script defer src="../static/js/main.js"></script>
<script>
    let allPhotos = [];
    let filteredPhotos = [];
    let currentModalIndex = 0;

    const gallery = document.getElementById('gallery');
    const filters = document.querySelectorAll('.filter-btn');
    const modal = document.getElementById('modal');
    const modalImage = document.getElementById('modal-image');
    const modalClose = document.getElementById('modal-close');
    const modalPrev = document.getElementById('modal-prev');
    const modalNext = document.getElementById('modal-next');

    async function loadPhotos() {
        try {
            const res = await fetch('/api/images');
            if (!res.ok) throw new Error();
            allPhotos = await res.json();
            filteredPhotos = allPhotos;
            renderPhotos();
        } catch (err) {
            gallery.innerHTML = '<div style="color:red; text-align:center;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
        }
    }

    function renderPhotos() {
        if (filteredPhotos.length === 0) {
            gallery.innerHTML = '<div style="color:#999; text-align:center; width:100%;">–ù–µ—Ç —Ñ–æ—Ç–æ</div>';
            return;
        }

        gallery.innerHTML = filteredPhotos.map((photo, i) => `
        <div class="photo-card" data-index="${i}">
          <img src="${photo.path}?v=${Date.now()}" alt="${photo.filename}" loading="lazy">
        </div>
      `).join('');

        document.querySelectorAll('.photo-card').forEach(card => {
            card.addEventListener('click', () => {
                const index = parseInt(card.dataset.index);
                openModal(index);
            });
        });
    }

    filters.forEach(btn => {
        btn.addEventListener('click', () => {
            filters.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const folder = btn.dataset.folder;
            filteredPhotos = folder === 'all' ? allPhotos : allPhotos.filter(p => p.folder === folder);
            renderPhotos();
        });
    });

    // --- –ú–û–î–ê–õ–ö–ê ---
    function openModal(index) {
        currentModalIndex = index;
        modalImage.src = filteredPhotos[index].path + '?v=' + Date.now();
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
    }
    function closeModal() {
        modal.classList.remove('active');
        document.body.style.overflow = '';
    }
    function showPrev() {
        currentModalIndex = (currentModalIndex - 1 + filteredPhotos.length) % filteredPhotos.length;
        modalImage.src = filteredPhotos[currentModalIndex].path + '?v=' + Date.now();
    }
    function showNext() {
        currentModalIndex = (currentModalIndex + 1) % filteredPhotos.length;
        modalImage.src = filteredPhotos[currentModalIndex].path + '?v=' + Date.now();
    }

    modalClose.onclick = closeModal;
    modalPrev.onclick = showPrev;
    modalNext.onclick = showNext;
    modal.onclick = (e) => { if (e.target === modal) closeModal(); };

    document.addEventListener('keydown', e => {
        if (!modal.classList.contains('active')) return;
        if (e.key === 'Escape') closeModal();
        if (e.key === 'ArrowLeft') showPrev();
        if (e.key === 'ArrowRight') showNext();
    });

    loadPhotos();
</script>

</body>
</html>